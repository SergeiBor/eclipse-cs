<project name="CheckstylePlugin" default="build.dist" basedir="../">
	
	<!-- get the environment properties specific to each developer machine -->
	<property file="${basedir}/build/env.properties"/>

	<!-- properties that likely change between releases -->
	<property file="${basedir}/build/version.properties"/>
	
	<!-- file and directory settings -->
	<property name="checkstyle.jar" value="checkstyle-all-${checkstyle.version}.jar" />
	<property name="plugin.name" value="com.atlassw.tools.eclipse.checkstyle_${plugin.version}" />

	<property name="dist.basedir" value="${basedir}/dist/" />
	<property name="dist.basedir.tmpdir" value="${basedir}/dist/tmp" />
	<property name="feature.project.dir" value="${basedir}/feature" />

	<!-- file names for the files to be distributed -->
	<property name="bin.dist.file" value="${plugin.name}${plugin.version.postfix}-bin.zip" />
	<property name="src.dist.file" value="${plugin.name}${plugin.version.postfix}-src.zip" />
	<property name="plugin.jar.file" value="${plugin.name}.jar" />
	<property name="feature.jar.file" value="${plugin.name}-feature.jar" />
	<property name="update.site.file" value="${plugin.name}${plugin.version.postfix}-updatesite.zip" />

	<!-- define ant4eclipse (used for compilation support) -->
	<taskdef resource="net/sf/ant4eclipse/antlib.xml" classpath="${basedir}/build/ant4eclipse-0.2.1.jar"/>

	<!-- ==================================================== -->
	<!--   CLEAN TARGET                                       -->
	<!-- ==================================================== -->
	<target name="clean" description="Cleans any directories and generated files">
		<delete dir="${dist.basedir}" failonerror="false" quiet="true" />
	</target>

	<!-- ==================================================== -->
	<!--   BUILD TARGET AREA                                  -->
	<!-- ==================================================== -->
	<target name="build.target.area" description="Build the directory structure of the target area">
		<mkdir dir="${dist.basedir}" />
		<mkdir dir="${dist.basedir.tmpdir}" />
	</target>

	<!-- ==================================================== -->
	<!--   DISTRIBUTION TARGET                                -->
	<!-- ==================================================== -->
	<target name="build.dist" depends="build.bindist,build.srcdist,build.local.update.site,build.plugin.website" />


	<!-- ==================================================== -->
	<!--   COMPILE TARGET                                     -->
	<!-- ==================================================== -->
	<target name="compile.sources" depends="build.target.area">

		<!-- resolve the org.eclipse.pde.core.requiredPlugins needed by ant4eclipse -->
		<path id="org.eclipse.pde.core.requiredPlugins" >
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.core.resources_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.ui_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.swt_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.jface_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.core.commands_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.ui.workbench_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.jface.text_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.text_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.jdt.core_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.core.runtime_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.osgi_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.ui.ide_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.jdt.ui_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.ui.workbench.texteditor_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.ui.editors_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.core.filebuffers_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.team.cvs.core_${eclipse.version}.jar" />
			<pathelement location="${eclipse.plugin.dir}/org.eclipse.team.core_${eclipse.version}.jar" />
		</path>

		<!-- init -->
		<mkdir dir="${dist.basedir.tmpdir}/bin" />
		<mkdir dir="${dist.basedir.tmpdir}/binnls" />

		<!-- read the eclipse classpath -->
		<getEclipseClasspath workspace="${workspace}" projectName="${project.name}" classpathId="build.classpath" />

		<!-- compile -->
		<javac srcdir="${basedir}/src" destdir="${dist.basedir.tmpdir}/bin" classpathref="build.classpath" source="1.4" />
		<javac srcdir="${basedir}/nls" destdir="${dist.basedir.tmpdir}/binnls" classpathref="build.classpath" source="1.4" />
	
		<!-- copy properties and other stuff -->
	    <copy todir="${dist.basedir.tmpdir}/bin">
	      <fileset dir="${basedir}/src" includes="**/*.properties"/>
	    </copy>
	</target>


	<!-- ==================================================== -->
	<!--   BINARY DISTRIBUTION TARGET                         -->
	<!-- ==================================================== -->
	<target name="build.bindist" depends="build.target.area,compile.sources,build.plugin.docs" description="Builds the binary distribution file">

		<!-- prefix paths within the binary dist file -->
		<property name="plugins.path" value="plugins/${plugin.name}" />
		<property name="features.path" value="features/${plugin.name}" />

		<!-- jar the contents of the output dirs into the tmp directory -->
		<jar destfile="${dist.basedir.tmpdir}/CheckstylePlugin.jar" basedir="${dist.basedir.tmpdir}/bin" index="true" />
		<jar destfile="${dist.basedir.tmpdir}/NLS.jar" basedir="${dist.basedir.tmpdir}/binnls" index="true" />
		<jar destfile="${dist.basedir.tmpdir}/CheckstyleMetadata.jar" basedir="${basedir}/metadata" index="true" />

		<!-- copy the plugin contents to the tmp dir -->
		<copy todir="${dist.basedir.tmpdir}/">
			<fileset dir="${basedir}">
				<include name="${checkstyle.jar}" />
				<include name="extension-libraries/**" />
				<include name="plugin.xml" />
				<include name="*.properties" />
				<include name="toc.xml" />
				<include name="README.html" />
				<include name="sun_checks.xml" />
				<include name="sun_checks_eclipse.xml" />
				<include name="META-INF/**" />
				<include name="schema/**" />
				<include name="icons/**" />
				<include name="license/**" />
			</fileset>
		</copy>

		<!-- zip the contents into the binary dist file -->
		<zip destfile="${dist.basedir}/${bin.dist.file}" update="false">
			<zipfileset dir="${dist.basedir.tmpdir}" prefix="${plugins.path}" includes="**/*" />
			<zipfileset dir="${feature.project.dir}" prefix="${features.path}" includes="**/*" />
		</zip>

		<!-- build the jars for the update site -->
		<zip destfile="${dist.basedir}/${plugin.jar.file}">
			<zipfileset dir="${dist.basedir.tmpdir}" includes="**/*" />
		</zip>
		<jar destfile="${dist.basedir}/${feature.jar.file}">
			<zipfileset dir="${feature.project.dir}" includes="**/*" />
		</jar>

		<!-- remove the temp directory -->
		<delete dir="${dist.basedir.tmpdir}" failonerror="false" quiet="true" />
	</target>

	<!-- ==================================================== -->
	<!--   SOURCE DISTRIBUTION TARGET                         -->
	<!-- ==================================================== -->
	<target name="build.srcdist" depends="build.target.area" description="Builds the source distribution file">

		<!-- The other way around is easier, just include all but the ouput directories -->
		<zip destfile="${dist.basedir}/${src.dist.file}" update="false">
			<fileset dir="${basedir}" includes="**/*">
				<exclude name="dist/**" />
				<exclude name="bin/**" />
				<exclude name="binnls/**" />
				<exclude name="build/env.properties" />
			</fileset>
		</zip>
	</target>

	<!-- ==================================================== -->
	<!--   BUILDS A LOCAL UPDATE SITE                         -->
	<!-- ==================================================== -->
	<target name="build.local.update.site" depends="build.bindist" description="Builds a local update site">

		<!-- prepare the site.xml file -->
		<copy file="${basedir}/build/local-site.template" tofile="${dist.basedir.tmpdir}/site.xml" />
		<replace file="${dist.basedir.tmpdir}/site.xml" token="@feature.jar.file@" value="${feature.jar.file}" />
		<replace file="${dist.basedir.tmpdir}/site.xml" token="@plugin.version@" value="${plugin.version}" />

		<!-- package the local update site -->
		<zip destfile="${dist.basedir}/${update.site.file}" update="false">
			<zipfileset dir="${dist.basedir.tmpdir}" includes="site.xml" />
			<zipfileset dir="${dist.basedir}" prefix="features" includes="${feature.jar.file}" />
			<zipfileset dir="${dist.basedir}" prefix="plugins" includes="${plugin.jar.file}" />
		</zip>

		<!-- remove the temp directory -->
		<delete dir="${dist.basedir.tmpdir}" failonerror="false" quiet="true" />
	</target>

	<!-- ==================================================== -->
	<!--   BUILD THE PLUGIN ONLINE DOCUMENTATION              -->
	<!-- ==================================================== -->
	<target name="build.plugin.docs">
		<copy todir="${dist.basedir.tmpdir}/doc">
			<fileset dir="${basedir}/doc" includes="*.css" />
			<fileset dir="${basedir}/doc" includes="images/**" />
		</copy>
		<copy todir="${dist.basedir.tmpdir}/doc/csdocs">
			<fileset dir="${checkstyle.docs.dir}" includes="**/*" />
		</copy>

		<xslt style="${basedir}/doc/generate_docs.xsl" basedir="${basedir}/doc" includes="*.html" destdir="${dist.basedir.tmpdir}/doc" />
	</target>

	<!-- ==================================================== -->
	<!--   BUILD THE PLUGIN WEBSITE                           -->
	<!-- ==================================================== -->
	<target name="build.plugin.website">
		<copy todir="${dist.basedir}/website">
			<fileset dir="${basedir}/doc" includes="*.css" />
			<fileset dir="${basedir}/doc" includes="images/**" />
			<fileset dir="${basedir}/doc" includes="update/**" />
		</copy>
		<copy todir="${dist.basedir}/website/dtds" flatten="true">
			<fileset dir="${basedir}/metadata" includes="**/*.dtd" />
		</copy>

		<xslt style="${basedir}/doc/generate_docs.xsl" basedir="${basedir}/doc" includes="*.html" destdir="${dist.basedir}/website">
			<param name="style" expression="website" />
		</xslt>
	</target>

	<!-- ==================================================== -->
	<!--   Release through Sourceforge File Release System    -->
	<!-- ==================================================== -->
	<!--
	<taskdef name="sfpublish" classname="org.apache.tools.ant.taskdefs.optional.sourceforge.SourceForgePublish" />

	<target name="sampletarget">

		<tstamp>
			<format property="release_date" pattern="MM/dd/yyyy hh:mm" locale="en" unit="minute" />
		</tstamp>

		<sfpublish releasename="v${4.0.0}${}" packagename="Eclipse Checkstyle Plug-in" packagehidden="no" hidden="yes" projectshortname="eclipse-cs" projectname="Eclipse Checkstyle Plug-in" username="myUsername" password="myPassword" releasedate="${release_date}">
			<filespec file="${dist.basedir}/${bin.dist.file}" filetype="zip_file" processortype="platform_independent" />
			<filespec file="${dist.basedir}/${src.dist.file}" filetype="zip_file" processortype="platform_independent" />
		</sfpublish>
		<sfpublish releasename="v${4.0.0}${plugin.version.postfix}" packagename="eclipse-cs Update Site" packagehidden="no" hidden="yes" projectshortname="eclipse-cs" projectname="Eclipse Checkstyle Plug-in" username="myUsername" password="myPassword" releasedate="${release_date}">
			<filespec file="${dist.basedir}/${plugin.jar.file}" filetype="jar_file" processortype="platform_independent" />
			<filespec file="${dist.basedir}/${feature.jar.file}" filetype="jar_file" processortype="platform_independent" />
		</sfpublish>
	</target>
	-->

</project>